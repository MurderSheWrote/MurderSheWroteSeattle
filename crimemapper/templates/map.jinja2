{% extends "index.html" %}
{% block map %}
  <form>
    <label><input id="All" type="checkbox" value="All" checked="checked">All</label>
    <label><input id="HOMICIDE" type="checkbox" value="HOMICIDE" class="option">Homicide</label>
    <label><input id="ASSAULT" type="checkbox" value="ASSAULT" class="option">Assault</label>
    <label><input id="WEAPON" type="checkbox" value="WEAPONS" class="option">Weapons</label>
    <label><input id="ROBBERY" type="checkbox" value="Robbery" class="option">Robbery</label>
    <label><input id="PROPERTY" type="checkbox" value="PROPERTY" class="option">Property</label>
    <label><input id="DRUGS" type="checkbox" value="DRUGS" class="option">Drugs/Alcohol</label>
    <label><input id="DISTURBANCE" type="checkbox" value="DISTRUBANCE" class="option">Disturbances</label>
    <label><input id="THEFT" type="checkbox" value="THEFT" class="option">Burglary/Theft</label>
    <label><input id="SIN" type="checkbox" value="SIN" class="option">Sin</label>
    <label><input id="FRAUD" type="checkbox" value="FRAUD" class="option">Fraud</label>
    <label><input id="OTHER" type="checkbox" value="OTHER" class="option">Other</label>
  </form>
  <button onclick="toggleHeatMap()">Click to toggle between markers and heatmap</button>
  <div id='map'></div>
  <div class="words">
      <p>Scroll around the map below to see a selection of police incidents in Seattle</p>
  </div>
  <a class="twitter-timeline" href="https://twitter.com/SeattlePD" data-widget-id="715243882074603520">Tweets by @SeattlePD</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  <script   src="https://code.jquery.com/jquery-2.2.2.min.js"   integrity="sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI="   crossorigin="anonymous"></script>
  <script>
    var markers = [];
    var sortedMarkers = {};
    var heatdata = [];
    var map, heatmap;

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat:47.6067006, lng:-122.3346896},
        zoom: 13
      });
      {% for crime in crimes %}
        sortedMarkers.{{ crime }} = [];
      {% endfor %}
      {% for place in places %}
        var marker = new google.maps.Marker({
          map: map,
          position: {{ place[0]|safe }},
          title: '{{place[1]}}',
          visible: true,
        });
        sortedMarkers['{{place[2] | upper }}'].push(marker);
        markers.push(marker);
        heatdata.push(marker.position);
        marker.setMap(map);
      {% endfor %}
      heatmap = new google.maps.visualization.HeatmapLayer({
        data: new google.maps.MVCArray(heatdata),
        map: map
      });
      heatmap.setMap(null);
    }

    function toggleHeatMap(){
      var boolVal = (heatmap.getMap() != null);
      toggleAllMarkerVisibility(boolVal);
      boolVal ? heatmap.setMap(null) : heatmap.setMap(map)
    }

    function sortVisibility(ischecked, crimeArray){
      for(var i = 0; i < crimeArray.length; i++){
        crimeArray[i].setVisible(ischecked)
      }
    }

    function allUncheck(){
      if ($('#All').is(':checked')){
        $('#All').prop('checked', false).trigger('change');
      }
    }

    function toggleAllMarkerVisibility(boolval){
      for (var i = 0; i < markers.length; i++) {
        markers[i].setVisible(boolval);
      };
      if(boolval){
        $('.option').prop('checked', false);
      }
    }

    $('#All').on('change', function(){
      var boolval = $('#All').is(':checked')? true : false;
      toggleAllMarkerVisibility(boolval);
    });

    {% for crime in crimes %}
    $('#' + "{{ crime }}").on('change', function(){
      allUncheck();
      sortVisibility(this.checked, sortedMarkers['{{ crime }}']);
    });
    {% endfor %}
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key={{ key }}&libraries=visualization&callback=initMap" async defer></script>
{% endblock map %}
